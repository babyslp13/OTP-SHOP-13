<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTPSHOP - System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ใช้ Firebase Compat Version เพื่อความเสถียรบนเว็บเบราว์เซอร์ -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #060608; color: white; margin: 0; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .btn-gradient { background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%); }
        input { background: #111118 !important; border: 1px solid #333 !important; color: white !important; outline: none; transition: 0.3s; }
        input:focus { border-color: #a855f7 !important; }
        .hidden { display: none; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen">

    <!-- หน้า Auth (Login / Register) -->
    <div id="auth-layer" class="fixed inset-0 z-[1000] bg-[#060608] flex items-center justify-center p-6">
        <div class="glass p-8 rounded-[2.5rem] w-full border border-purple-500/20 shadow-2xl">
            <h2 id="auth-title" class="text-2xl font-black italic uppercase text-center mb-6 text-purple-500">Login</h2>
            
            <div class="space-y-4">
                <input type="text" id="auth-username" placeholder="Username (ชื่อผู้ใช้)" class="w-full p-4 rounded-2xl text-sm">
                
                <div id="reg-fields" class="hidden space-y-4">
                    <input type="email" id="auth-email" placeholder="Email (สำหรับกู้รหัสผ่าน)" class="w-full p-4 rounded-2xl text-sm">
                    <input type="password" id="auth-pass" placeholder="Password (6 ตัวขึ้นไป)" class="w-full p-4 rounded-2xl text-sm">
                    <input type="password" id="auth-confirm" placeholder="Confirm Password" class="w-full p-4 rounded-2xl text-sm">
                </div>

                <div id="login-fields">
                    <input type="password" id="auth-login-pass" placeholder="Password" class="w-full p-4 rounded-2xl text-sm">
                </div>

                <button onclick="handleAuth()" class="w-full btn-gradient p-4 rounded-2xl font-black uppercase tracking-widest mt-2 active:scale-95 transition">ตกลง</button>
                
                <p class="text-center text-xs text-gray-500 mt-4">
                    <span id="toggle-text">ยังไม่มีบัญชี?</span>
                    <button onclick="toggleMode()" class="text-purple-500 font-bold" id="toggle-btn">สมัครสมาชิก</button>
                </p>
            </div>
        </div>
    </div>

    <!-- หน้าหลักหลัง Login -->
    <div id="main-app" class="hidden p-6">
        <header class="flex justify-between items-center mb-10">
            <span class="font-black text-xl italic uppercase">OTP<span class="text-purple-500">Shop</span></span>
            <div class="glass px-4 py-2 rounded-2xl text-purple-400 font-black" id="balance-display">฿ 0.00</div>
        </header>
        <div class="glass p-10 rounded-[2.5rem] text-center">
            <p class="text-sm mb-2 text-gray-400 italic">ยินดีต้อนรับ</p>
            <h3 class="text-xl font-bold text-purple-500 mb-8" id="user-display">---</h3>
            <button onclick="auth.signOut()" class="w-full bg-red-500/10 text-red-500 p-4 rounded-2xl font-bold uppercase text-[10px] border border-red-500/20 shadow-lg">ออกจากระบบ</button>
        </div>
    </div>

    <script>
        // ใช้รหัส Config ที่คุณเพิ่งได้มา
        const firebaseConfig = {
            apiKey: "AIzaSyAnC_H0mfIJWY_Y73kRFnjtWZvOHIOOopQ",
            authDomain: "project-otp-shop.firebaseapp.com",
            projectId: "project-otp-shop",
            storageBucket: "project-otp-shop.firebasestorage.app",
            messagingSenderId: "832041026630",
            appId: "1:832041026630:web:47e06a714d93ff7d58f647",
            measurementId: "G-Q1XLN31ZJ2"
        };

        // เริ่มต้นการทำงาน Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "shop-otp-v1"; // ID สำหรับแยกข้อมูลใน Firestore

        let isLogin = true;

        function toggleMode() {
            isLogin = !isLogin;
            document.getElementById('auth-title').innerText = isLogin ? 'Login' : 'Register';
            document.getElementById('reg-fields').classList.toggle('hidden', isLogin);
            document.getElementById('login-fields').classList.toggle('hidden', !isLogin);
            document.getElementById('toggle-btn').innerText = isLogin ? 'สมัครสมาชิก' : 'เข้าสู่ระบบ';
            document.getElementById('toggle-text').innerText = isLogin ? 'ยังไม่มีบัญชี?' : 'มีบัญชีอยู่แล้ว?';
        }

        async function handleAuth() {
            const username = document.getElementById('auth-username').value.trim().toLowerCase();
            if(!username) return alert('กรุณากรอก Username');

            try {
                if(isLogin) {
                    const password = document.getElementById('auth-login-pass').value;
                    // ล็อกอินผ่านอีเมลจำลอง (Username-Based)
                    await auth.signInWithEmailAndPassword(`${username}@shop.internal`, password);
                } else {
                    const email = document.getElementById('auth-email').value.trim();
                    const password = document.getElementById('auth-pass').value;
                    const confirmPass = document.getElementById('auth-confirm').value;

                    if(!email || !password) return alert('กรุณากรอกข้อมูลให้ครบ');
                    if(password !== confirmPass) return alert('รหัสผ่านไม่ตรงกัน');
                    if(password.length < 6) return alert('รหัสผ่านต้องมีอย่างน้อย 6 ตัว');

                    // 1. สร้างบัญชีอีเมลจริงสำหรับกู้รหัส
                    const res = await auth.createUserWithEmailAndPassword(email, password);
                    
                    // 2. บันทึกข้อมูลลงฐานข้อมูล Firestore
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(res.user.uid).set({
                        username: username,
                        recoveryEmail: email,
                        balance: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // 3. สร้างทางลัดสำหรับการล็อกอินด้วย Username
                    try { await auth.createUserWithEmailAndPassword(`${username}@shop.internal`, password); } catch(e){}
                    
                    alert('สมัครสมาชิกสำเร็จแล้ว!');
                }
            } catch (err) {
                console.error(err);
                if(err.code === 'auth/email-already-in-use') alert('Username หรือ Email นี้ถูกใช้งานแล้ว');
                else if(err.code === 'auth/wrong-password') alert('รหัสผ่านไม่ถูกต้อง');
                else alert('เกิดข้อผิดพลาด: ' + err.message);
            }
        }

        // ฟังการเปลี่ยนแปลงสถานะล็อกอิน
        auth.onAuthStateChanged(user => {
            const authLayer = document.getElementById('auth-layer');
            const mainApp = document.getElementById('main-app');

            if (user) {
                authLayer.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                // ดึงข้อมูล User จาก Firestore
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(user.uid)
                .onSnapshot(doc => {
                    if(doc.exists) {
                        const data = doc.data();
                        document.getElementById('user-display').innerText = data.username;
                        document.getElementById('balance-display').innerText = `฿ ${data.balance.toFixed(2)}`;
                    } else {
                        // กรณีเป็นบัญชีจำลอง (Username-based) ให้ค้นหาข้อมูลจริง
                        db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                        .where('username', '==', user.email.split('@')[0])
                        .get().then(snap => {
                            if(!snap.empty) {
                                const data = snap.docs[0].data();
                                document.getElementById('user-display').innerText = data.username;
                                document.getElementById('balance-display').innerText = `฿ ${data.balance.toFixed(2)}`;
                            }
                        });
                    }
                });
            } else {
                authLayer.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        });
    </script>
</body>
</html>

